#!/bin/sh
##
## Gets the root process id for a documentum content server process.  Copied from dm_shutdown_edms and converted to a shell script.
## Should be run with an environment like dmadmin, may return blank otherwise.
## Mark Faine (6/6/09)
## $Id: get_pid 24 2011-06-22 19:44:24Z mark.faine@gmail.com $

## 2017-01-18 Gareth McMillan
## Coppied from Mark's work, updated to use DCTM7.3

#to be placed in $DM_HOME/bin/

if [ $# -lt 2 ]; then
  echo "Usage $0 docbase superuser"
  exit 1
fi

## Include environment in this script so that it doesn't have to be included in dependent scripts.

DOCUMENTUM=<%=@documentum%>
DM_SERVER_VERSION=$(ls -lA ${DOCUMENTUM}/product | grep drwx | awk '{ print $9 }' | tr -d / | sort -n -r | head -n 1)
DM_HOME=${DOCUMENTUM}/product/${DM_SERVER_VERSION}
DM_LOG=${DOCUMENTUM}/dba/log

## Source the environment with the dm_set_server_env script
setEnvScript=/etc/profile.d/documentum.sh
if [ -e $setEnvScript ]; then
. $setEnvScript
else
   echo "Missing environment script"
  exit 1
fi

DOCBASE=$1
DMUSER=$2
echo `${DM_HOME}/bin/iapi ${DOCBASE} -U${DMUSER} -P -e << EOF  | grep 'root_pid' | sed -e 's/ .*[: A-Za-z]//'
apply,s0,NULL,LIST_SESSIONS
next,s0,q0
dump,s0,q0
exit
EOF`
